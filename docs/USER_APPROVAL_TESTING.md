# 用戶審核系統測試清單

本文件提供完整的測試步驟，用於驗證用戶審核系統的所有功能是否正常運作。

## 測試前準備

### 1. 環境設定檢查

確認以下環境變數已正確設定：

```bash
# 資料庫
DATABASE_URL=postgresql://...

# Google OAuth
GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...
GOOGLE_REDIRECT_URI=...

# 郵件服務
RESEND_API_KEY=...
FROM_EMAIL=noreply@yourdomain.com
FROM_NAME=Third-Party 管理系統
APP_URL=https://your-domain.com

# Session
SESSION_SECRET=...
```

### 2. 資料庫遷移

確認資料庫已執行最新的遷移：

```bash
# 檢查 users 表是否有以下欄位
- status (pending/approved/rejected)
- department
- approved_by
- approved_at
- rejection_reason

# 檢查 departments 表是否存在
- id, name, description, created_at, updated_at
```

### 3. 測試帳號準備

準備以下測試帳號：

1. **管理員帳號**：已存在的 admin 用戶（kipoteam@...）
2. **測試用戶 A**：用於測試批准流程
3. **測試用戶 B**：用於測試拒絕流程
4. **測試用戶 C**：用於測試解除封鎖流程

---

## 測試案例

### Test Case 1: 新用戶註冊流程

**目的**：驗證新用戶透過 Google OAuth 註冊後，狀態為 pending

**步驟**：
1. ✅ 使用未註冊的 Google 帳號訪問系統
2. ✅ 點擊「使用 Google 登入」
3. ✅ 完成 Google OAuth 授權
4. ✅ 驗證是否被導向到 `/waiting-approval` 頁面
5. ✅ 確認頁面顯示「等待管理員審核」訊息

**預期結果**：
- 用戶資料寫入資料庫，status = 'pending'
- 無法進入系統主頁面
- 顯示友善的等待審核頁面

---

### Test Case 2: 管理員查看待審核用戶

**目的**：驗證管理員可以看到所有待審核的用戶

**步驟**：
1. ✅ 以管理員身份登入系統
2. ✅ 前往「系統管理」頁面
3. ✅ 點擊「人員權限」分頁
4. ✅ 切換到「待審核」分頁
5. ✅ 確認可以看到 Test Case 1 建立的用戶

**預期結果**：
- 待審核分頁顯示橘色徽章，數字正確
- 用戶列表顯示姓名、Email、註冊時間
- 每個用戶有「批准」和「拒絕」按鈕

---

### Test Case 3: 批准用戶（含郵件通知）

**目的**：驗證管理員可以批准用戶，並發送通知郵件

**前置條件**：
- 已設定 RESEND_API_KEY
- FROM_EMAIL 的網域已在 Resend 驗證

**步驟**：
1. ✅ 在「待審核」分頁中，點擊某用戶的「批准」按鈕
2. ✅ 在彈出的對話框中選擇部門（例如：IT）
3. ✅ 點擊「確認批准」
4. ✅ 確認操作成功訊息顯示
5. ✅ 檢查該用戶是否移動到「已啟用」分頁
6. ✅ 檢查用戶的郵箱是否收到批准通知郵件
7. ✅ 驗證郵件內容包含：
   - 用戶姓名
   - 分配的部門
   - 登入系統的連結

**預期結果**：
- 用戶狀態更新為 'approved'
- 部門欄位正確設定
- approved_by 和 approved_at 欄位已填寫
- 郵件成功發送，內容正確

**資料庫驗證**：
```sql
SELECT id, name, email, status, department, approved_by, approved_at
FROM users
WHERE email = 'test-user-a@example.com';
```

---

### Test Case 4: 批准用戶後登入測試

**目的**：驗證被批准的用戶可以正常登入系統

**步驟**：
1. ✅ 登出管理員帳號
2. ✅ 使用剛被批准的測試帳號登入
3. ✅ 驗證是否成功進入系統主頁面
4. ✅ 確認可以訪問各個功能頁面
5. ✅ 確認側邊欄顯示正確的用戶資訊

**預期結果**：
- 登入成功，無錯誤訊息
- 可以正常使用系統所有功能
- 用戶資訊顯示正確

---

### Test Case 5: 拒絕用戶（含郵件通知）

**目的**：驗證管理員可以拒絕用戶申請，並發送通知郵件

**步驟**：
1. ✅ 以管理員身份登入
2. ✅ 前往「系統管理 > 人員權限 > 待審核」
3. ✅ 點擊某用戶的「拒絕」按鈕
4. ✅ 在彈出的對話框中輸入拒絕原因（例如：「非公司員工」）
5. ✅ 點擊「確認拒絕」
6. ✅ 確認操作成功訊息顯示
7. ✅ 檢查該用戶是否移動到「已拒絕」分頁
8. ✅ 檢查用戶的郵箱是否收到拒絕通知郵件
9. ✅ 驗證郵件內容包含拒絕原因

**預期結果**：
- 用戶狀態更新為 'rejected'
- rejection_reason 欄位已填寫
- 郵件成功發送，內容正確

**資料庫驗證**：
```sql
SELECT id, name, email, status, rejection_reason
FROM users
WHERE email = 'test-user-b@example.com';
```

---

### Test Case 6: 被拒絕用戶嘗試登入

**目的**：驗證被拒絕的用戶無法登入系統

**步驟**：
1. ✅ 登出管理員帳號
2. ✅ 使用被拒絕的測試帳號嘗試登入
3. ✅ 驗證是否被導向到 `/access-denied` 頁面
4. ✅ 確認頁面顯示拒絕原因
5. ✅ 確認頁面提供聯繫管理員的資訊

**預期結果**：
- 無法進入系統主頁面
- 顯示友善的拒絕頁面
- 拒絕原因清楚顯示

---

### Test Case 7: 解除封鎖用戶

**目的**：驗證管理員可以解除被拒絕用戶的封鎖狀態

**步驟**：
1. ✅ 以管理員身份登入
2. ✅ 前往「系統管理 > 人員權限 > 已拒絕」
3. ✅ 找到 Test Case 5 被拒絕的用戶
4. ✅ 點擊「解除封鎖」按鈕
5. ✅ 在確認對話框中點擊「確定」
6. ✅ 確認操作成功訊息顯示
7. ✅ 檢查該用戶是否移動到「待審核」分頁
8. ✅ 確認拒絕原因已清除

**預期結果**：
- 用戶狀態更新為 'pending'
- rejection_reason 欄位清空
- 用戶重新出現在待審核列表

**資料庫驗證**：
```sql
SELECT id, name, email, status, rejection_reason
FROM users
WHERE email = 'test-user-b@example.com';
```

---

### Test Case 8: 解除封鎖後重新批准

**目的**：驗證解除封鎖的用戶可以被重新批准

**步驟**：
1. ✅ 在「待審核」分頁中找到剛解除封鎖的用戶
2. ✅ 點擊「批准」按鈕
3. ✅ 選擇部門並確認
4. ✅ 驗證用戶移動到「已啟用」分頁
5. ✅ 確認郵件發送成功
6. ✅ 使用該帳號登入測試

**預期結果**：
- 批准流程正常運作
- 郵件發送成功
- 用戶可以正常登入

---

### Test Case 9: 分頁計數器驗證

**目的**：驗證三個分頁的用戶數量統計正確

**步驟**：
1. ✅ 查看「已啟用」分頁的數字徽章
2. ✅ 查看「待審核」分頁的數字徽章（應為橘色）
3. ✅ 查看「已拒絕」分頁的數字徽章
4. ✅ 手動計算每個分頁的用戶數量
5. ✅ 確認徽章數字與實際數量一致

**預期結果**：
- 所有徽章數字正確
- 待審核徽章為橘色且顯眼
- 數字即時更新

---

### Test Case 10: 郵件服務錯誤處理

**目的**：驗證當郵件服務失敗時，系統仍能正常運作

**步驟**：
1. ✅ 暫時移除或設定錯誤的 RESEND_API_KEY
2. ✅ 嘗試批准一個用戶
3. ✅ 檢查伺服器日誌中的錯誤訊息
4. ✅ 確認用戶狀態仍然更新為 'approved'
5. ✅ 確認操作成功訊息仍然顯示
6. ✅ 恢復正確的 RESEND_API_KEY

**預期結果**：
- 郵件發送失敗不影響核心功能
- 錯誤被正確記錄在日誌中
- 用戶狀態更新成功

---

### Test Case 11: 並發操作測試

**目的**：驗證多個管理員同時操作時的資料一致性

**步驟**：
1. ✅ 開啟兩個瀏覽器視窗
2. ✅ 兩個視窗都以管理員身份登入
3. ✅ 在視窗 A 批准某用戶
4. ✅ 在視窗 B 重新整理頁面
5. ✅ 確認視窗 B 看到最新狀態

**預期結果**：
- 資料更新即時反映
- 無資料不一致問題

---

### Test Case 12: 權限驗證

**目的**：驗證非管理員無法訪問審核功能

**步驟**：
1. ✅ 以一般用戶身份登入
2. ✅ 嘗試訪問 `/admin` 頁面
3. ✅ 確認被拒絕訪問或重新導向

**預期結果**：
- 一般用戶無法訪問管理頁面
- 顯示適當的錯誤訊息或重新導向

---

## 測試結果記錄

| Test Case | 狀態 | 測試日期 | 測試人員 | 備註 |
|-----------|------|----------|----------|------|
| TC-1: 新用戶註冊 | ⏳ 待測試 | - | - | - |
| TC-2: 查看待審核 | ⏳ 待測試 | - | - | - |
| TC-3: 批准用戶 | ⏳ 待測試 | - | - | - |
| TC-4: 批准後登入 | ⏳ 待測試 | - | - | - |
| TC-5: 拒絕用戶 | ⏳ 待測試 | - | - | - |
| TC-6: 拒絕後登入 | ⏳ 待測試 | - | - | - |
| TC-7: 解除封鎖 | ⏳ 待測試 | - | - | - |
| TC-8: 重新批准 | ⏳ 待測試 | - | - | - |
| TC-9: 分頁計數 | ⏳ 待測試 | - | - | - |
| TC-10: 錯誤處理 | ⏳ 待測試 | - | - | - |
| TC-11: 並發操作 | ⏳ 待測試 | - | - | - |
| TC-12: 權限驗證 | ⏳ 待測試 | - | - | - |

**狀態說明**：
- ⏳ 待測試
- ✅ 通過
- ❌ 失敗
- ⚠️ 部分通過

---

## 已知問題與限制

### 目前限制

1. **郵件發送**：
   - 需要設定 Resend API Key
   - 需要驗證發信網域
   - 免費方案有發信數量限制

2. **測試環境**：
   - 測試郵件可能進入垃圾郵件匣
   - 需要真實的 Google 帳號進行測試

3. **資料庫**：
   - 需要手動執行 migration SQL
   - 現有用戶需要手動更新 status 欄位

### 未來改進

1. 增加批量操作功能（批量批准/拒絕）
2. 增加審核歷史記錄
3. 增加郵件範本自訂介面
4. 增加用戶申請時的自我介紹欄位
5. 增加部門管理功能（新增/編輯/刪除部門）

---

## 緊急問題處理

### 如果郵件服務完全失敗

1. 檢查 RESEND_API_KEY 是否正確
2. 檢查 FROM_EMAIL 網域是否已驗證
3. 查看 Railway 日誌中的錯誤訊息
4. 暫時註解掉郵件發送代碼，先確保核心功能運作

### 如果用戶無法登入

1. 檢查資料庫中的 status 欄位
2. 確認 auth.server.ts 中的邏輯正確
3. 檢查 session 是否正常運作
4. 查看瀏覽器 console 的錯誤訊息

### 如果審核介面無法顯示

1. 檢查 admin.tsx 的 loader 函數
2. 確認資料庫連線正常
3. 檢查 UserManager 元件是否正確引入
4. 查看瀏覽器 Network 面板的 API 回應

---

## 聯絡資訊

如有任何測試問題，請聯繫：
- **系統管理員**：kipoteam@...
- **技術支援**：查看 GitHub Issues

---

**文件版本**：1.0  
**最後更新**：2026-02-03  
**下次審查**：功能上線後一週
